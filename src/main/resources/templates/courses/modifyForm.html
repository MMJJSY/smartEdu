<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <title>ê°•ì¢Œ ìˆ˜ì • ìš”ì²­</title>
  <link rel="stylesheet" th:href="@{/css/courses_modify.css}">
</head>

<body>
  <main class="course-request">
    <h2>ê°•ì¢Œ ìˆ˜ì • ìš”ì²­</h2>

    <form th:action="@{/courses/modify}" method="post" enctype="multipart/form-data" id="modifyForm">
      <input type="hidden" name="courseId" th:value="${course.courseId}">
      <!-- ê¸°ì¡´ ì´ë¯¸ì§€ ìœ ì§€ìš© -->
      <input type="hidden" name="oldPicture" th:value="${course.img}">
      <input type="hidden" id="deletedLectureIds" name="deletedLectureIds">

      <!-- ê°•ì¢Œ ê¸°ë³¸ì •ë³´ -->
      <label>ì œëª©</label>
      <input type="text" name="title" th:value="${course.title}" required>

      <label>ê°•ì¢Œ ì†Œê°œê¸€</label>
      <textarea name="description" rows="3" th:text="${course.description}" required></textarea>

      <div class="info-row">
        <div>
          <label>ì¹´í…Œê³ ë¦¬</label>
          <select name="category">
            <option value="BACKEND" th:selected="${course.category == 'BACKEND'}">ë°±ì—”ë“œ</option>
            <option value="FRONTEND" th:selected="${course.category == 'FRONTEND'}">í”„ë¡ íŠ¸ì—”ë“œ</option>
            <option value="DATABASE" th:selected="${course.category == 'DATABASE'}">ë°ì´í„°ë² ì´ìŠ¤</option>
          </select>
        </div>
        <div>
          <label>ê°€ê²© (ì›)</label>
          <input type="number" name="price" min="0" th:value="${course.price}" required>
        </div>
      </div>

      <div class="info-row">
        <div>
          <label>ê°•ì‚¬ ì´ë¦„</label>
          <input type="text" name="instructorName" readonly th:value="${course.instructorName}">
          <input type="hidden" name="instructorId" th:value="${course.instructorId}">
        </div>
        <div>
          <label>ì¸ë„¤ì¼ ì´ë¯¸ì§€ ë³€ê²½</label>
          <input type="file" name="img" accept="image/*">
          <div th:if="${course.img != null}" style="margin-top: 5px;">
            <small>í˜„ì¬ ì´ë¯¸ì§€: </small>
            <img th:src="@{'/upload/course/' + ${course.img}}" alt="ì¸ë„¤ì¼ ë¯¸ë¦¬ë³´ê¸°"
              style="width:80px;height:50px;object-fit:cover;border:1px solid #ddd;border-radius:4px;">
          </div>
        </div>
      </div>

      <label>ìˆ˜ì • ìš”ì²­ ë‚´ìš©</label>
      <textarea name="modifyComment" rows="3" placeholder="ìˆ˜ì •ì´ í•„ìš”í•œ ì´ìœ ë‚˜ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" required></textarea>

      <hr>

      <!-- ê°•ì˜ ìˆ˜ì • ì˜ì—­ -->
      <section class="lecture-section">
        <h3>ê°•ì˜ ëª©ë¡ ìˆ˜ì •</h3>
        <table id="lectureTable">
          <thead>
            <tr>
              <th>íšŒì°¨</th>
              <th>ê°•ì˜ëª…</th>
              <th>ì˜ìƒ ë³€ê²½</th>
              <th>ì‚­ì œ</th>
            </tr>
          </thead>
          <tbody>
            <tr th:each="lec, stat : ${lectureList}">
              <td>
                <span th:text="${lec.sectionNo} + 'ê°•'">1ê°•</span>
                <input type="hidden" th:name="'lecturesModify[' + ${stat.index} + '].lectureId'"
                  th:value="${lec.lectureId}">
                <input type="hidden" th:name="'lecturesModify[' + ${stat.index} + '].sectionNo'"
                  th:value="${lec.sectionNo}">
                <input type="hidden" th:name="'lecturesModify[' + ${stat.index} + '].oldVideo'" th:value="${lec.video}">
              </td>
              <td>
                <input type="text" th:name="'lecturesModify[' + ${stat.index} + '].title'" th:value="${lec.title}"
                  required>
              </td>
              <td>
                <input type="file" th:name="'lecturesModify[' + ${stat.index} + '].video'" accept="video/mp4,video/*">

                <!-- í˜„ì¬ íŒŒì¼ í‘œì‹œ + ë³´ê¸° ë§í¬ -->
                <div th:if="${lec.video != null}" style="margin-top:6px;">
                  <small>í˜„ì¬ íŒŒì¼: </small>
                  <a th:href="@{/courses/getVideoPage(lectureId=${lec.lectureId})}" target="_blank" th:text="${
             #strings.contains(lec.video,'$$') 
               ? #strings.substring(lec.video, #strings.indexOf(lec.video,'$$') + 2) 
               : lec.video
           }">í˜„ì¬_íŒŒì¼ëª….mp4</a>
                </div>

                <!-- ì˜ìƒ ì—†ìŒ í‘œì‹œ -->
                <div th:if="${lec.video == null}" style="margin-top:6px;">
                  <small>í˜„ì¬ íŒŒì¼: ì—†ìŒ</small>
                </div>
              </td>
              <td><button type="button" class="btn-delete" onclick="deleteLecture(this)">ì‚­ì œ</button></td>
            </tr>
          </tbody>
        </table>
        <button type="button" class="btn-add" onclick="addLecture()">+ íšŒì°¨ ì¶”ê°€í•˜ê¸°</button>
      </section>

      <div class="submit-box">
        <button type="submit" class="btn-submit">ìˆ˜ì • ìš”ì²­ ë³´ë‚´ê¸°</button>
      </div>
    </form>

  </main>

  <script>
    function nextIdx() {
      return document.querySelectorAll("#lectureTable tbody tr").length;
    }

    function addLecture() {
      const tbody = document.querySelector("#lectureTable tbody");
      const idx = nextIdx();
      const tr = document.createElement("tr");
      tr.innerHTML = `
      <td>${idx + 1}ê°•
        <input type="hidden" name="lecturesModify[${idx}].sectionNo" value="${idx + 1}">
        <input type="hidden" name="lecturesModify[${idx}].lectureId" value="0">
        <input type="hidden" name="lecturesModify[${idx}].oldVideo" value="">
      </td>
      <td><input type="text" name="lecturesModify[${idx}].title" required></td>
      <td><input type="file" name="lecturesModify[${idx}].video" accept="video/mp4,video/*"></td>
      <td><button type="button" class="btn-delete" onclick="deleteLecture(this)">ì‚­ì œ</button></td>
    `;
      tbody.appendChild(tr);
    }

    function deleteLecture(btn) {
      const tr = btn.closest("tr");
      // í˜„ì¬ í–‰ì˜ lectureId ì¶”ì¶œ
      const idInput = tr.querySelector("input[name*='.lectureId']");
      const lectureId = idInput ? parseInt(idInput.value || "0", 10) : 0;

      // DBì— ì¡´ì¬í•˜ëŠ” í–‰(lectureId > 0)ë§Œ ì‚­ì œëª©ë¡ì— ì¶”ê°€
      if (lectureId > 0) {
        const hidden = document.getElementById("deletedLectureIds");
        const prev = hidden.value ? hidden.value.split(",").filter(v => v) : [];
        if (!prev.includes(String(lectureId))) {
          prev.push(String(lectureId));
          hidden.value = prev.join(",");
        }
      }

      // í™”ë©´ì—ì„œ í–‰ ì œê±°
      tr.remove();

      // ğŸ‘‰ ì¸ë±ìŠ¤ ì¬ì •ë ¬(ì´ë¦„ë“¤ì„ lecturesModify[0..n]ìœ¼ë¡œ ë‹¤ì‹œ ë§ì¶¤)
      const rows = document.querySelectorAll("#lectureTable tbody tr");
      rows.forEach((row, i) => {
        row.querySelectorAll("[name^='lecturesModify[']").forEach(input => {
          input.name = input.name.replace(/lecturesModify\[\d+\]/, `lecturesModify[${i}]`);
        });

        const sectionHidden = row.querySelector(`input[name='lecturesModify[${i}].sectionNo']`);
        if (sectionHidden) sectionHidden.value = i + 1;

        // â–¶ spanìœ¼ë¡œ ê°±ì‹ 
        const span = row.querySelector("td > span");
        if (span) span.textContent = `${i + 1}ê°•`;
      });
    }

    // ì œì¶œ ì „ ë§ˆì§€ë§‰ ì •ë¦¬
    document.getElementById("modifyForm").addEventListener("submit", function (e) {
      // ì¸ë±ìŠ¤ ìµœì¢… ë³´ì •
      const rows = document.querySelectorAll("#lectureTable tbody tr");
      rows.forEach((tr, i) => {
        tr.querySelectorAll("[name^='lecturesModify[']").forEach(input => {
          input.name = input.name.replace(/lecturesModify\[\d+\]/, `lecturesModify[${i}]`);
        });
      });

      if (!this.checkValidity()) { e.preventDefault(); this.reportValidity(); return; }
      if (!confirm("ìˆ˜ì • ìš”ì²­ì„ ë³´ë‚¼ê¹Œìš”?")) { e.preventDefault(); return; }
    });
  </script>
</body>

</html>